<div>
  <div class="top-menu">
    <div ngbDropdown class="dropdown me-2">
      <button class="btn btn-opt btn-sm dropdown-toggle" ngbDropdownToggle>
        <fa-icon [icon]="faFolder"></fa-icon> Arquivo
      </button>
      <div ngbDropdownMenu>
        <button class="dropdown-item" (click)="openResizeModal(newPictureModal)">
          <fa-icon [icon]="faFile"></fa-icon> Novo
        </button>

        <label class="dropdown-item">
          <fa-icon [icon]="faUpload"></fa-icon> Abrir
          <input
            type="file"
            accept="image/*"
            (change)="handleImageUpload($event)"
            hidden
          />
        </label>

        <button class="dropdown-item" (click)="saveDrawing()">
          <fa-icon [icon]="faSave"></fa-icon> Salvar
        </button>

        <button class="dropdown-item" (click)="openResizeModal(resizeModal)">
          <fa-icon [icon]="faCogs"></fa-icon> Propriedades
        </button>
      </div>
    </div>
  </div>

  <div class="top-tools">
    <div class="tool-descri">
      @if (tool == Tool.Pencil) {
        <fa-icon [icon]="faPencil"></fa-icon>
        <b>Pincel</b>
      } @else if (tool == Tool.Eraser) {
        <fa-icon [icon]="faEraser"></fa-icon>
        <b>Borracha</b>
      } @else if (tool == Tool.Eyedropper) {
        <fa-icon [icon]="faEyeDropper"></fa-icon>
        <b>Conta-gotas</b>
      } @else if (tool == Tool.Bucket) {
        <fa-icon [icon]="faFillDrip"></fa-icon>
        <b>Balde de tinta</b>
      } @else if (tool == Tool.Zoom) {
        <fa-icon [icon]="faSearch"></fa-icon>
        <b>Zoom</b>
      }
    </div>
    @if (useCursorBrush()) {
      <div class="container-slider-tools me-1">
        <select class="form-select form-select-sm" [(ngModel)]="brushType" style="width: auto">
          <option [value]="BrushType.Round">Padrão</option>
          <option [value]="BrushType.Spray">Spray</option>
          <option [value]="BrushType.Square">Quadrado</option>
        </select>
      </div>
      <div class="container-slider-tools me-2">
        <b class="form-label me-2 mb-0">Tamanho:</b>
        <input
          type="range"
          min="1"
          max="50"
          [(ngModel)]="lineWidth"
          class="form-range"
          style="width: 150px;"
        />
        <span class="ms-1">{{ lineWidth }} px</span>
      </div>
      <div class="container-slider-tools">
        <b class="form-label me-2 mb-0">Opacidade:</b>
        <input
          type="range"
          min="0"
          max="1"
          step="0.1"
          [(ngModel)]="opacity"
          class="form-range"
          style="width: 150px;"
        />
        <span class="ms-1">{{ (opacity * 100) | number: '1.0-0' }}%</span>
      </div>
    }
    <div class="container-slider-tools" *ngIf="tool == Tool.Bucket">
      <label class="form-label me-2 mb-0">Tolerância:</label>
      <input
        type="range"
        min="1"
        max="50"
        [(ngModel)]="tolerance"
        class="form-range"
        style="width: 150px;"
      />
      <span class="ms-1">{{ tolerance }} px</span>
    </div>
    <div class="container-slider-tools" *ngIf="tool == Tool.Zoom">
      <select class="form-select form-select-sm" [(ngModel)]="zoomType">
        <option value="in">Zoom In</option>
        <option value="out">Zoom Out</option>
      </select>
    </div>
  </div>

  <div class="footer-menu">
    <div class="container-slider-tools ms-auto">
      <label class="form-label me-2 mb-0">Zoom: </label>
      <input
        type="range"
        min="0.1"
        max="4"
        step="0.1"
        [(ngModel)]="zoom"
        class="form-range"
        style="width: 150px;"
        (ngModelChange)="updateCanvasTransforms()"
      />
      <span class="ms-1">{{ (zoom * 100) | number: '1.0-0' }}%</span>
    </div>
  </div>

  <div class="container-draw">
    <div class="container-tools p-1">
      <button class="btn btn-tool" 
        [class.active]="tool === Tool.Pencil"
        [ngbTooltip]="'Pincel (B)'" 
        placement="end"
        (click)="selectTool(Tool.Pencil)">
        <fa-icon [icon]="faPencil"></fa-icon>
      </button>
      <button class="btn btn-tool" 
        [class.active]="tool === Tool.Eraser"
        [ngbTooltip]="'Borracha (E)'" 
        placement="end"
        (click)="selectTool(Tool.Eraser)">
        <fa-icon [icon]="faEraser"></fa-icon>
      </button>
      <button class="btn btn-tool"
        [class.active]="tool === Tool.Bucket" 
        [ngbTooltip]="'Balde de tinta (G)'" 
        placement="end"
        (click)="selectTool(Tool.Bucket)">
        <fa-icon [icon]="faFillDrip"></fa-icon>
      </button>
      <button class="btn btn-tool"
        [class.active]="tool === Tool.Eyedropper" 
        [ngbTooltip]="'Conta-gotas (I)'" 
        placement="end"
        (click)="selectTool(Tool.Eyedropper)">
        <fa-icon [icon]="faEyeDropper"></fa-icon>
      </button>
      <button class="btn btn-tool"
        [class.active]="tool === Tool.Zoom" 
        [ngbTooltip]="'Zoom (Z)'" 
        placement="end"
        (click)="selectTool(Tool.Zoom)">
        <fa-icon [icon]="faSearch"></fa-icon>
      </button>
      <div class="color-swatches">
        <div
          class="color-swatch primary"
          [class.active]="activeColorSlot === 'primary'"
          [style.background]="primaryColor"
          (click)="activeColorSlot = 'primary'"
        ></div>

        <div
          class="color-swatch secondary"
          [class.active]="activeColorSlot === 'secondary'"
          [style.background]="secondaryColor"
          (click)="activeColorSlot = 'secondary'"
        ></div>

        <button class="btn-swap" (click)="swapColors()" [ngbTooltip]="'Swap Colors (X)'" placement="end">
          <fa-icon [icon]="faRotateLeft"></fa-icon>
        </button>
      </div>
    </div>

    <div class="container-canva">
       <div
        #canvasContainer
        class="my-canva"
        (pointerdown)="startDrawing($event)"
        (pointermove)="draw($event); updateCursor($event)"
        (pointerup)="stopDrawing()"
        (pointerleave)="stopDrawing(); hideCursor()"
        (contextmenu)="callContextMenu($event)"
        [style.cursor]="getToolCursor()"
      >
        <div
          class="back-square"
          [style.width.px]="picture.width"
          [style.height.px]="picture.height"
        ></div>

        <!-- renderiza os canvas pela ordem da array -->
        <canvas
          *ngFor="let layer of layers"
          class="absolute-canvas"
          [hidden]="!layer.visible"
          [attr.data-id]="layer.id"
          width="{{ picture.width }}"
          height="{{ picture.height }}"
          [style.pointer-events]="layer.id === activeLayerId ? 'auto' : 'none'"
          #canvasRefs
        ></canvas>
      </div>

      <div
        class="brush-preview"
        [ngStyle]="{
          width: (lineWidth * zoom) + 'px',
          height: (lineWidth * zoom) + 'px',
          top: cursorY + 'px',
          left: cursorX + 'px',
          display: useCursorBrush() ? 'block' : 'none',
          borderColor: tool === Tool.Eraser ? '#f00' : '#fff'
        }"
      ></div>
    </div>
    
    <div class="tools-right">
      <div class="tools-box">
        <div class="tbox-tittle" (click)="toggleBoxPreview()">Preview</div>
        @if (openBoxPreview) {
          <div class="canvas-preview back-square">
            <canvas #previewCanvas></canvas>
          </div>
        }
      </div>

      <div class="tools-box">
        <div class="tbox-tittle" (click)="toggleBoxColor()">Cor</div>
        @if (openBoxColor) {
          <app-color-picker [selectedColor]="activeColorSlot === 'primary' ? primaryColor : secondaryColor" (colorSelected)="onColorChange($event)"></app-color-picker>
        }
      </div>

      <app-layer-panel
        [layers]="layers"
        [activeLayerId]="activeLayerId"
        (onCreateLayer)="createLayer()"
        (onRemoveLayer)="removeLayer($event)"
        (onDuplicateLayer)="duplicateLayer()"
        (onToggleLayer)="toggleLayer($event)"
        (onSetActiveLayer)="setActiveLayer($event)"
        (layersReordered)="onLayersReordered($event)">
      </app-layer-panel>
    </div>
  </div>

  <ng-template #newPictureModal let-modal>
    <new-picture-component
      (createNewPicture)="createNewPicture($event)"
      (close)="modal.dismiss()">
    </new-picture-component>
  </ng-template>

  <ng-template #resizeModal let-modal>
    <config-component [picture]="picture" 
      (resizeCanvas)="applyResize($event)"
      (close)="modal.dismiss()">
    </config-component>
  </ng-template>

</div>